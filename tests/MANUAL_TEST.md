#!/bin/bash

echo "=== BioLink Agentic Chat Application Testing Guide ==="
echo ""

echo "1. START SERVICES:"
echo "   cd /Users/menyawino/Playground/BioLink/Code"
echo "   docker-compose up -d"
echo ""

echo "2. WAIT FOR INITIALIZATION (2-3 minutes):"
echo "   - Ollama needs to load the phi:latest model"
echo "   - PostgreSQL needs to initialize"
echo "   - Backend needs to connect to database"
echo ""

echo "3. VERIFY SERVICES ARE RUNNING:"
echo "   # Check backend health"
echo "   curl http://localhost:3001/health"
echo ""
echo "   # Check Ollama model"
echo "   curl http://localhost:11434/api/tags"
echo ""
echo "   # Check frontend"
echo "   curl -I http://localhost:3000"
echo ""

echo "4. TEST SQL AGENT API DIRECTLY:"
echo ""
echo "   # Simple count query"
echo "   curl -X POST http://localhost:3001/api/chat/sql-agent \\"
echo "     -H 'Content-Type: application/json' \\"
echo "     -d '{\"message\": \"How many patients are in the database?\"}'"
echo ""
echo "   # Average query"
echo "   curl -X POST http://localhost:3001/api/chat/sql-agent \\"
echo "     -H 'Content-Type: application/json' \\"
echo "     -d '{\"message\": \"What is the average age of patients?\"}'"
echo ""
echo "   # Visualization query"
echo "   curl -X POST http://localhost:3001/api/chat/sql-agent \\"
echo "     -H 'Content-Type: application/json' \\"
echo "     -d '{\"message\": \"Show age distribution by gender\"}'"
echo ""

echo "5. OPEN WEB INTERFACE:"
echo "   http://localhost:3000"
echo ""

echo "6. TEST QUERIES IN CHAT INTERFACE:"
echo ""
echo "   BASIC QUERIES (should respond quickly):"
echo "   - 'How many patients are there?'"
echo "   - 'What is the average age?'"
echo "   - 'Count patients by gender'"
echo "   - 'Show me patient nationalities'"
echo ""
echo "   VISUALIZATION QUERIES (will generate plots):"
echo "   - 'Show age distribution'"
echo "   - 'Plot BMI vs heart rate'"
echo "   - 'Show EF distribution by gender'"
echo "   - 'Display patient count by nationality'"
echo ""
echo "   COMPLEX QUERIES:"
echo "   - 'Find patients with EF < 40 and age > 50'"
echo "   - 'Show average systolic BP for diabetic patients'"
echo "   - 'Plot the relationship between age and ejection fraction'"
echo "   - 'How many patients have hypertension?'"
echo ""

echo "7. EXPECTED BEHAVIOR:"
echo "   ✓ Data queries → SQL generation + execution + natural language response"
echo "   ✓ Visualization requests → SQL + execution + plot generation + embedded image"
echo "   ✓ Regular chat → Falls back to Ollama for non-data questions"
echo "   ✓ Error handling → Graceful failures with helpful messages"
echo ""

echo "8. TROUBLESHOOTING:"
echo ""
echo "   If queries hang or fail:"
echo "   docker-compose logs backend | tail -20"
echo "   docker-compose logs ollama | tail -10"
echo ""
echo "   If no plots appear:"
echo "   docker-compose exec backend python -c \"import matplotlib; print('Matplotlib OK')\""
echo ""
echo "   If database errors:"
echo "   docker-compose exec postgres psql -U biolink -d biolink -c 'SELECT COUNT(*) FROM patients;'"
echo ""
echo "   Restart services:"
echo "   docker-compose restart"
echo ""

echo "9. PERFORMANCE NOTES:"
echo "   - First query may be slow (model loading)"
echo "   - Visualization queries take longer (plot generation)"
echo "   - Simple counts should be < 5 seconds"
echo "   - Complex queries with plots may take 15-30 seconds"
echo ""

echo "=== HAPPY TESTING! ==="